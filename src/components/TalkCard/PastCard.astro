---
import PresenterAvatar from "./PresenterAvatar.astro";
import ActionButtons from "./ActionButtons.astro";
import AbstractSection from "./AbstractSection.astro";
import Keywords from "./Keywords.astro";
import InvitedBy from "./InvitedBy.astro";
import {getBorderClass} from "../../utils/constants";

const {talk, compactable = false} = Astro.props;
const cardId = `talk-card-${talk.id}`;
const borderClass = getBorderClass(talk.presenter.continent);
---

<article
        class={`bg-white rounded-2xl shadow-md hover:shadow-xl transition-all overflow-hidden border-l-4 snap-start shrink-0 ${borderClass} hover:scale-[1.02]`}
        data-card-id={cardId}
>
    <div class={compactable ? 'p-4' : 'p-6'}>
        <div class="compact-card-content">
            <div class="flex flex-col sm:flex-row items-center gap-4 hover:cursor-pointer" id="card-header">
                <div class="flex flex-row items-center gap-3 flex-1 w-full">
                    <PresenterAvatar presenter={talk.presenter} size="medium"/>
                    <div class="flex-1 min-w-0 break-words text-center sm:text-left">
                        <h3 class="talk-title text-base font-semibold text-gray-800 line-clamp-2 mb-1 break-words"
                            title={talk.title}>
                            {talk.title}
                        </h3>
                        <p class="text-sm text-gray-600 break-words">
                            <a
                                    href={talk.presenter.link}
                                    target="_blank"
                                    rel="noreferrer"
                                    class="font-semibold text-gray-800 hover:opacity-80"
                            >
                                {talk.presenter.name}
                            </a>
                            {`, ${talk.presenter.affiliation}`}
                        </p>
                    </div>
                </div>

                <ActionButtons talk={talk} stopPropagation={true}/>
            </div>

            <div class="compact-expanded-content hidden mt-4 pt-4 border-t border-gray-200">
                <ActionButtons talk={talk} compact={true} stopPropagation={true}/>

                <AbstractSection abstract={talk.abstract}/>
                <Keywords keywords={talk.keywords}/>
                <InvitedBy invitedBy={talk.invitedBy}/>

                {talk.youtubeEmbed && (
                        <div class="mt-4 rounded-xl overflow-hidden shadow-lg">
                            <div class="relative aspect-video youtube-placeholder" data-src={talk.youtubeEmbed}>
                                <button class="absolute inset-0 flex items-center justify-center bg-black/40 text-white hover:bg-black/60 transition-colors"
                                        title="Click to load video">
                                    <svg class="w-16 h-16 text-white opacity-90" fill="currentColor"
                                         viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                )}
            </div>
        </div>
    </div>
</article>

<script define:vars={{cardId}}>
    (function () {
        const card = document.querySelector(`[data-card-id="${cardId}"]`);
        if (!card) return;

        const expandedContent = card.querySelector('.compact-expanded-content');
        const header = card.querySelector('#card-header');

        if (header && expandedContent) {
            header.addEventListener('click', (e) => {
                if (e.target.closest('a, button, summary')) return;
                expandedContent.classList.toggle('hidden');
                card.classList.toggle('expanded');
            });

        }

        card.addEventListener('click', (e) => {
            const placeholder = e.target.closest('.youtube-placeholder');
            if (!placeholder || placeholder.querySelector('iframe')) return;

            const src = placeholder.getAttribute('data-src');
            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.title = 'YouTube video player';
            iframe.className = 'absolute inset-0 w-full h-full';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture;';
            iframe.referrerPolicy = 'strict-origin-when-cross-origin';
            iframe.allowFullscreen = true;

            placeholder.innerHTML = '';
            placeholder.appendChild(iframe);
        });
    })();
</script>
<style>

    .talk-title {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        transition: all 0.2s ease;
    }

    article.expanded .talk-title {
        -webkit-line-clamp: unset;
        display: block;
        overflow: visible;
    }
</style>
