---
import PresenterAvatar from "./PresenterAvatar.astro";
import ActionButtons from "./ActionButtons.astro";
import AbstractSection from "./AbstractSection.astro";
import Keywords from "./Keywords.astro";
import InvitedBy from "./InvitedBy.astro";
import {getBorderClass} from "../../utils/constants";

const {talk, compactable = false} = Astro.props;
const cardId = `talk-card-${talk.datePrague}`;
// Ensure presenters is an array
const presenters = Array.isArray(talk.presenter) ? talk.presenter : [talk.presenter];
const borderClass = getBorderClass(presenters[0].continent);
---

<article
        class={`bg-white rounded-2xl shadow-md hover:shadow-xl transition-all overflow-hidden border-l-4 snap-start shrink-0 ${borderClass} hover:scale-[1.02]`}
        data-card-id={cardId}
>
    <div class={compactable ? 'p-4' : 'p-6'}>
        <div class="compact-card-content">
            <div class={`card-header flex ${presenters.length > 1 ? 'flex-col gap-3' : 'flex-col sm:flex-row items-center gap-4'} hover:cursor-pointer`}>
                
                {presenters.length > 1 ? (
                    /* Multi-Presenter Layout: Title top, then list of (Avatar + Name) rows */
                    <div class="w-full">
                         <div class="flex justify-between items-start gap-4">
                            <h3 class="talk-title text-base font-semibold text-gray-800 line-clamp-2 mb-3 break-words flex-1"
                                title={talk.title}>
                                {talk.title}
                            </h3>
                             <ActionButtons talk={talk} stopPropagation={true}/>
                         </div>
                        
                        <div class="flex flex-col sm:flex-row flex-wrap gap-4">
                            {presenters.map(presenter => (
                                <div class="flex flex-row items-center gap-3">
                                    <PresenterAvatar presenter={presenter} size="medium"/>
                                    <div class="min-w-0 break-words">
                                        <p class="font-semibold text-gray-800 leading-tight">
                                            <a
                                                    href={presenter.link}
                                                    target="_blank"
                                                    rel="noreferrer"
                                                    class="hover:opacity-80"
                                            >
                                                {presenter.name}
                                            </a>
                                        </p>
                                        <p class="text-sm text-gray-600 leading-tight">
                                           {presenter.affiliation}
                                        </p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                ) : (
                    /* Single Presenter Layout: Avatar Left, Title+Content Right */
                    <>
                        <div class="flex flex-row items-center gap-3 flex-1 w-full">
                            <PresenterAvatar presenter={presenters[0]} size="medium"/>
                            <div class="flex-1 min-w-0 break-words text-center sm:text-left">
                                <h3 class="talk-title text-base font-semibold text-gray-800 line-clamp-2 mb-1 break-words"
                                    title={talk.title}>
                                    {talk.title}
                                </h3>
                                <p class="text-sm text-gray-600 break-words">
                                    <a
                                            href={presenters[0].link}
                                            target="_blank"
                                            rel="noreferrer"
                                            class="font-semibold text-gray-800 hover:opacity-80"
                                    >
                                        {presenters[0].name}
                                    </a>
                                    {`, ${presenters[0].affiliation}`}
                                </p>
                            </div>
                        </div>
                        <ActionButtons talk={talk} stopPropagation={true}/>
                    </>
                )}
            </div>

            <div class="compact-expanded-content hidden mt-4 pt-4 border-t border-gray-200">
                <ActionButtons talk={talk} compact={true} stopPropagation={true}/>

                <AbstractSection abstract={talk.abstract}/>
                <Keywords keywords={talk.keywords}/>
                <InvitedBy invitedBy={talk.invitedBy}/>

                {talk.youtubeEmbed && (
                        <div class="mt-4 rounded-xl overflow-hidden shadow-lg">
                            <div class="relative aspect-video youtube-placeholder" data-src={talk.youtubeEmbed}>
                                {/* Video will load automatically on expansion */}
                            </div>
                        </div>
                )}
            </div>
        </div>
    </div>
</article>

<script>
    document.addEventListener('click', (e) => {
        const header = e.target.closest('.card-header');
        if (!header) return;

        // Prevent expansion when clicking interactive elements
        if (e.target.closest('a, button, summary')) return;

        const card = header.closest('article');
        const expandedContent = card.querySelector('.compact-expanded-content');

        if (card && expandedContent) {
            expandedContent.classList.toggle('hidden');
            card.classList.toggle('expanded');

            // Auto-load video if expanding
            if (!expandedContent.classList.contains('hidden')) {
                const placeholder = expandedContent.querySelector('.youtube-placeholder');
                if (placeholder && !placeholder.querySelector('iframe')) {
                    const src = placeholder.getAttribute('data-src');
                    if (src) {
                        const iframe = document.createElement('iframe');
                        iframe.src = src;
                        iframe.title = 'YouTube video player';
                        iframe.className = 'absolute inset-0 w-full h-full';
                        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture;';
                        iframe.referrerPolicy = 'strict-origin-when-cross-origin';
                        iframe.allowFullscreen = true;

                        placeholder.innerHTML = '';
                        placeholder.appendChild(iframe);
                    }
                }
            }
        }
    });
</script>
<style>

    .talk-title {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        transition: all 0.2s ease;
    }

    article.expanded .talk-title {
        -webkit-line-clamp: unset;
        display: block;
        overflow: visible;
    }
</style>
